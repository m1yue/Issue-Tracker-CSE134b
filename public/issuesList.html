<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="./styles/style.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">

    <title>Issues List</title>
</head>
<body>

    <nav><a href="login.html">Sign Out</a></nav>

    <h1> Current Issues <i class="fas fa-exclamation-circle" title="Exclamation Icon"></i></h1>
    <hr>

    <div id="bugList"></div><br>

    <div id="dialog"></div>


    <template id="issueFormTemplate">
        <b>Add Issue:</b>
        <form id="addForm">
            <label for="title">Title:</label>
            <input type="text" id="title" name="title"><br>
            <label for="type">Type:</label>
            <input type="text" id="type" name="type"><br>
            <label for="priority">Priority:</label>
                    <select name="priority" id="priority">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select><br>
            <input type="hidden" id="closed" name="closed" value="false">
            <button id="addIssueBtn" type="button">Add</button>
            <button id="cancelBtn" type="button">Cancel</button>
        </form>
    </template>


    <script>
            // easy global use just kicks to change easily
            const url = 'http://localhost:3000/issues';
            
            // when page loads, load those issues
            window.addEventListener('DOMContentLoaded', function () {
                getIssues();
            });
       
            // getIssues - simple fetch from the end point getting current issues state
            function getIssues() {
       
              // change to fetch API if you are so inclined
              let xhr = new XMLHttpRequest();
              xhr.open('GET', url, true);
              xhr.onload = function () {
                renderIssues(this.responseText);
              }
              xhr.send();
            }
       
           // renderIssues - render the passed issues using template literals as opposed to template tags to show possibilities
           // approach deeply buries in the markup though!
           function renderIssues(issues) {
       
              issues = JSON.parse(issues);
       
              let output = `<button id="e" onclick="addIssue()"><i class="fas fa-plus-square"> Add Issue</i></button><br><br>
                            <table>
                            <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Closed?</th>
                            </tr>
                            </thead>
                            <tbody>` 
               + (issues.map(issue => 
               `<tr data-id="${issue.id}" data-issue='`+JSON.stringify(issue)+`'>
                 <td>${issue.title}</td>
                 <td>${issue.type}</td>
                 <td>${issue.priority}</td>
                 <td>${issue.closed}</td>
                <td class="modifyBtns"><i onclick="deleteIssue(${issue.id})" class="far fa-trash-alt" title="Delete Issue"></i></td>
               </tr>`
              )).join('')+
              `</tbody></table>`;
            
              document.querySelector("#bugList").innerHTML = output;
            }
       
            // addIssue - notice that the differences between add and Edit are minor you could combine but readability might be hurt
            function addIssue() {
                // clone a blank add form from the template
                let template = document.querySelector('#issueFormTemplate');
                let clone = document.importNode(template.content, true);

                //empty innerHTML and append new dialog
                document.querySelector('#dialog').innerHTML = "";
                document.querySelector('#dialog').appendChild(clone);
                

                // wire the add action, can use addEventListener if you like
                document.querySelector('#addIssueBtn').onclick = function () {

                    let formData = new FormData(document.querySelector('#addForm'));
                    let payload = {};
                    formData.forEach(function(value, key){
                                    payload[key] = value;
                            });
                    payload = JSON.stringify(payload);
                    
                    let xhr = new XMLHttpRequest();
                    xhr.open('POST', url, true);
                    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8')
                    xhr.onload = function () {
                    // no error checking done here!
                    // bad idea to go and refetch issues, network is easy but... need a store 
                    getIssues();
                    }
                    xhr.send(payload);

                    document.querySelector("#dialog").innerHTML = "";
                }

                // wire the cancel event, can use addEventListener if you like
                document.querySelector('#cancelBtn').onclick = function () {
                    document.querySelector('#dialog').innerHTML = "";  
                }
            }

            // deleteIssue - really basic delete with confirm idea to show how you can mock and then remove with fancier stuff later
            function deleteIssue(id) {
                
                function confirmDelete() {
                    // simple example of incrementalism - use cheesy built-in confirm first.  Change to fancy one later
                    return window.confirm('Delete issue?')
                }

                if (!confirmDelete())
                return;  

                let xhr = new XMLHttpRequest();
                xhr.open('DELETE', url+'/'+id, true);
                xhr.onload = function () {
                    // no error checking done here
                    // bad idea to go and refetch issues...lots of network - need a store :-)
                    getIssues();
                }
                xhr.send();
            }
           </script>  
</body>
</html>